worker_processes auto;

events {
    worker_connections 1024;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;

    # Дополнительные MIME-типы для стриминга
    types {
        application/vnd.apple.mpegurl m3u8;
        video/mp2t ts;
        application/dash+xml mpd;
        video/mp4 mp4 m4s m4v m4a;
    }

    server {
        listen 80;
        server_name localhost;

        # Корневая директория с плейлистами
        root /var/www/playlists;

        # CORS заголовки для всех запросов
        add_header Access-Control-Allow-Origin *;
        add_header Access-Control-Allow-Methods 'GET, OPTIONS';
        add_header Access-Control-Allow-Headers 'Range, Origin, Content-Type, Accept';
        add_header Access-Control-Expose-Headers 'Content-Length, Content-Range';

        # HLS стримы: /stream/{video_name}/hls/...
        location ~ ^/stream/([^/]+)/hls/(.*)$ {
            alias /var/www/playlists/$1/hls/$2;

            # Отключаем кеширование для манифестов
            location ~* \.m3u8$ {
                add_header Cache-Control "no-cache, no-store, must-revalidate";
                add_header Access-Control-Allow-Origin *;
            }

            # Кешируем сегменты
            location ~* \.ts$ {
                add_header Cache-Control "public, max-age=31536000";
                add_header Access-Control-Allow-Origin *;
            }
        }

        # DASH стримы: /stream/{video_name}/dash/...
        location ~ ^/stream/([^/]+)/dash/(.*)$ {
            alias /var/www/playlists/$1/dash/$2;

            # Отключаем кеширование для манифестов
            location ~* \.mpd$ {
                add_header Cache-Control "no-cache, no-store, must-revalidate";
                add_header Access-Control-Allow-Origin *;
            }

            # Кешируем сегменты
            location ~* \.(m4s|mp4)$ {
                add_header Cache-Control "public, max-age=31536000";
                add_header Access-Control-Allow-Origin *;
            }
        }

        # Прямой доступ к плейлистам: /{video_name}/[hls|dash]/...
        location / {
            try_files $uri $uri/ =404;

            # Кеширование для манифестов
            location ~* \.(m3u8|mpd)$ {
                add_header Cache-Control "no-cache, no-store, must-revalidate";
                add_header Access-Control-Allow-Origin *;
            }

            # Кеширование для сегментов
            location ~* \.(ts|m4s|mp4)$ {
                add_header Cache-Control "public, max-age=31536000";
                add_header Access-Control-Allow-Origin *;
            }
        }

        # Health check
        location /health {
            return 200 'OK';
            add_header Content-Type text/plain;
        }
    }
}
